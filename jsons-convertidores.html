<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Conversor de CSV a JSON</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
    body {
        font-family: Arial;
        padding: 20px;
        background: #f2f2f2;
    }
    input, select, button {
        margin: 5px;
    }
    textarea {
        width: 100%;
        height: 400px;
        margin-top: 10px;
    }
</style>
</head>

<body>

<h2>Conversor CSV → JSON + Actualización por Año/Semestre</h2>

<div>
    <input id="file" type="file" accept=".xlsx,.xls">
    <input id="anio" placeholder="Año ej: 2025" style="width:100px">
    <select id="semestre">
        <option value="primer_semestre">Primer Semestre</option>
        <option value="segundo_semestre">Segundo Semestre</option>
    </select>
    <button id="btn">Procesar CSV</button>
    <button id="dl" disabled>Descargar JSON</button>
</div>

<textarea id="out"></textarea>

<script>

// -------------------------------------------
// 1) LEER JSON ANTERIOR
// -------------------------------------------

let jsonAnterior = null;

async function cargarJSONAnterior() {
    try {
        const r = await fetch("presupuesto.json");
        jsonAnterior = await r.json();
    } catch (e) {
        console.warn("No se encontró presupuesto.json, se creará uno nuevo.");
        jsonAnterior = {};
    }
}
cargarJSONAnterior();


// -------------------------------------------
// 2) PROCESAR CSV
// -------------------------------------------

document.getElementById("btn").addEventListener("click", async () => {

    const file = document.getElementById("file").files[0];
    if (!file) {
        alert("Selecciona un archivo CSV/XLSX primero.");
        return;
    }

    const anio = document.getElementById("anio").value.trim();
    const semestre = document.getElementById("semestre").value;

    if (!anio) {
        alert("Debes ingresar un año.");
        return;
    }

    // Leer XLSX
    const data = await file.arrayBuffer();
    const workbook = XLSX.read(data);
    const sheetName = workbook.SheetNames[0];
    const rows = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { defval: "" });

    // Salida parcial creada desde el CSV
    const salida = {
        secretarias: {}
    };

    // -------------------------------------------
    // 3) EXTRAER DATOS DEL CSV
    // (ajusta campos según tus columnas reales)
    // -------------------------------------------

    rows.forEach(row => {
        const secretaria = row["Secretaría"] || "";
        const direccion = row["Dirección"] || "";
        const codigoZ = row["Z"] || "";
        const presupuestado = parseFloat(row["Presupuestado"] || 0);
        const reestructura = parseFloat(row["Reestructurado"] || 0);
        const comprometido = parseFloat(row["Ejecutado"] || 0);

        if (!secretaria) return;

        if (!salida.secretarias[secretaria]) {
            salida.secretarias[secretaria] = {
                direcciones: []
            };
        }

        let dir = salida.secretarias[secretaria].direcciones.find(d => d.direccion === direccion);
        if (!dir) {
            dir = {
                direccion,
                gastos: []
            };
            salida.secretarias[secretaria].direcciones.push(dir);
        }

        dir.gastos.push({
            codigoZ,
            presupuestado,
            reestructura,
            comprometido
        });
    });


    // -------------------------------------------
    // 4) FUSIONAR CSV en JSON EXISTENTE
    // -------------------------------------------

    // Asegurar año
    if (!jsonAnterior[anio]) {
        jsonAnterior[anio] = {};
    }

    // Crear semestre si no existe
    if (!jsonAnterior[anio][semestre]) {

        // Buscar una estructura base para clonar
        let base = null;
        const aniosExist = Object.keys(jsonAnterior).sort().reverse();

        for (let a of aniosExist) {
            const sems = Object.keys(jsonAnterior[a]);
            if (sems.length > 0) {
                base = jsonAnterior[a][sems[0]];
                break;
            }
        }

        if (base) {
            // Clonar estructura (secretarias, direcciones, funcionarios...)
            jsonAnterior[anio][semestre] = JSON.parse(JSON.stringify(base));
        } else {
            // Si no existe ningún año/semestre previo
            jsonAnterior[anio][semestre] = { secretarias: {} };
        }
    }

    // Destino final donde se insertan montos nuevos
    const destino = jsonAnterior[anio][semestre];

    // Fusionar montos
    Object.keys(salida.secretarias).forEach(sec => {

        if (!destino.secretarias[sec]) {
            console.warn("La secretaría no existe en el JSON base:", sec);
            return;
        }

        const secCSV = salida.secretarias[sec];
        const secDEST = destino.secretarias[sec];

        secCSV.direcciones.forEach(dirCSV => {

            const dirDEST = secDEST.direcciones.find(d => d.direccion === dirCSV.direccion);
            if (!dirDEST) {
                console.warn("La dirección no existe en el JSON base:", dirCSV.direccion);
                return;
            }

            // Actualizar solo montos
            dirCSV.gastos.forEach(gCSV => {
                const gDEST = dirDEST.gastos.find(g => g.codigoZ == gCSV.codigoZ);
                if (gDEST) {
                    gDEST.presupuestado = gCSV.presupuestado;
                    gDEST.reestructura = gCSV.reestructura;
                    gDEST.comprometido = gCSV.comprometido;
                }
            });
        });

    });


    // -------------------------------------------
    // 5) MOSTRAR JSON FINAL + HABILITAR DESCARGA
    // -------------------------------------------

    const finalStr = JSON.stringify(jsonAnterior, null, 2);
    document.getElementById("out").value = finalStr;

    const dl = document.getElementById("dl");
    dl.disabled = false;
    dl.onclick = () => descargar(finalStr, "presupuesto.json");

});


// -------------------------------------------
// Fun Descarga
// -------------------------------------------

function descargar(texto, nombre) {
    const blob = new Blob([texto], { type: "application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = nombre;
    a.click();
}

</script>

</body>
</html>
