<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Transparencia Municipal</title>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* GENERAL */
        html, body {
            margin: 0; padding: 0; height: 100vh;
            background: #f5f5f5; font-family: "Roboto", sans-serif;
            overflow-x: hidden;
        }

        /* NAVBAR SUPERIOR */
        #top-navbar {
            background: #1b5e20; height: 64px; 
            display: flex; align-items: center;
            position: fixed; top: 0; width: 100%; z-index: 1000;
            padding: 0 15px;
        }
        #top-navbar img { height: 45px; margin-left: 10px; }
        .sidenav-trigger { color: white !important; display: block; }

        /* LAYOUT */
        #layout { padding-top: 64px; display: flex; }

        /* SIDEBAR / SIDENAV */
        .sidenav {
            background: #1b5e20; color: white;
            padding-top: 20px; width: 280px;
        }
        .sidebar-title { padding: 14px 20px; font-size: 15px; font-weight: bold; color: rgba(255,255,255,0.8); text-transform: uppercase; }
        .collapsible-header { background: transparent !important; color: white !important; border: 0 !important; padding-left: 45px !important; }
        .collection-item { background: #1b5e20 !important; color: white !important; border: 0 !important; cursor: pointer; padding-left: 50px !important; }
        .collection-item:hover { background: rgba(255,255,255,0.1) !important; }

        /* MAIN CONTENT */
        #main {
            flex-grow: 1;
            padding-left: 280px; /* Ajustado al ancho exacto del sidenav */
            width: 100%;
        }

        @media (max-width: 992px) {
            #main { padding-left: 0; }
        }

        /* TABS & SCROLLBAR PERSONALIZADO */
        .tabs { 
            background: #4a148c !important; 
            margin: 0 !important; 
            width: 100% !important;
            border-radius: 0 !important;
            height: 48px !important;
        }
        
        /* Estilo de la barra de scroll */
        .tabs::-webkit-scrollbar { 
            height: 6px; /* Un poquito más gruesa para que se vea el diseño */
        }
        .tabs::-webkit-scrollbar-track { 
            background: rgba(255, 255, 255, 0.15); /* Fondo blanco translúcido visible */
        }
        .tabs::-webkit-scrollbar-thumb { 
            background: red; /* Barra blanca sólida */
            border-radius: 10px;
        }

        .tabs .tab a { color: rgba(255,255,255,0.7) !important; }
        .tabs .tab a.active { background: rgba(255,255,255,0.2) !important; color: white !important; }
        .tabs .indicator { background-color: white !important; }

        /* BENTO GRID */
        #direccion-content { padding: 15px; }
        .bento-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        @media (min-width: 601px) {
            .bento-grid { grid-template-columns: 1fr 1fr; }
            #progress-card { grid-column: span 2; }
        }

        .bento-item { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        #grafico-card { min-height: 320px; }

        /* PROGRESS BARS */
        .progress-title { font-size: 13px; margin-bottom: 5px; font-weight: 500; }
        .progress { height: 16px; background-color: #e0e0e0; border-radius: 8px; margin-bottom: 12px; }
        .progress .determinate { border-radius: 8px; background-color: #4a148c !important; }

        #logo-final { text-align: center; padding: 20px; margin-top: 30px; }
</style>
</head>

<body>

    <nav id="top-navbar">
        <a href="#" data-target="slide-out" class="sidenav-trigger"><i class="material-icons">menu</i></a>
        <img src="imagenes/pico.png" alt="Logo">
    </nav>

    <div id="layout">
        <ul id="slide-out" class="sidenav sidenav-fixed">
            <div class="sidebar-title">Semestres</div>
            <ul class="collapsible collapsible-accordion" id="semestres-collapsible">
                </ul>
            <div class="divider" style="background:rgba(255,255,255,0.1)"></div>
            <div class="sidebar-title">Opciones</div>
            <li><a class="modal-trigger white-text" href="#modal-anios"><i class="material-icons left white-text">calendar_today</i>Años anteriores</a></li>
            <div id="logo-final">
                <img src="imagenes/ome.png" style="width:50%; opacity:0.8;">
            </div>
        </ul>

        <main id="main">
            <div class="hide-on-large-only" style="padding: 10px; background: #fff;">
                <label>Dirección:</label>
                <select id="direcciones-select" class="browser-default" style="border:1px solid #4a148c; padding:8px; border-radius:4px;"></select>
            </div>

            <ul class="tabs hide-on-med-and-down" id="direcciones-tabs"></ul>

            <div id="direccion-content">
                <div class="bento-grid">
                    <div class="bento-item" id="funcionarios-card">
                        <div id="func-list">Seleccione una secretaría en el menú.</div>
                    </div>
                    <div class="bento-item" id="grafico-card">
                        <canvas id="chart-actual"></canvas>
                    </div>
                    <div class="bento-item" id="progress-card">
                        <div id="progress-container">
                            <div><div class="progress-title">1 - Gastos en Personal</div><div class="progress"><div class="determinate"></div></div></div>
                            <div><div class="progress-title">2 - Bienes de Consumo</div><div class="progress"><div class="determinate"></div></div></div>
                            <div><div class="progress-title">3 - Servicios No Personales</div><div class="progress"><div class="determinate"></div></div></div>
                            <div><div class="progress-title">4 - Transferencias Sociales</div><div class="progress"><div class="determinate"></div></div></div>
                            <div><div class="progress-title">5 - Bienes de Capital</div><div class="progress"><div class="determinate"></div></div></div>
                            <div><div class="progress-title">6 - Trabajo Público</div><div class="progress"><div class="determinate"></div></div></div>
                            <div><div class="progress-title">7 - Créditos</div><div class="progress"><div class="determinate"></div></div></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="modal-anios" class="modal">
        <div class="modal-content">
            <h4>Seleccionar Año</h4>
            <div id="lista-anios" class="collection"></div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Inicialización de Materialize
            M.Sidenav.init(document.querySelectorAll('.sidenav'));
            M.Modal.init(document.querySelectorAll('.modal'));
            
            let dataGlobal = null;
            let YEAR_SELECTED = null;
            let chartInstance = null;
            const Z_MAPPING = { "Z=1": 0, "Z=2": 1, "Z=3": 2, "Z=4": 3, "Z=5": 4, "Z=6": 5, "Z=7": 6 };
            const PROGRESS_TITLES = Array.from(document.querySelectorAll('#progress-container .progress-title')).map(t => t.innerText.split('—')[0].trim());

            fetch("presupuesto.json")
                .then(r => r.json())
                .then(data => {
                    dataGlobal = data;
                    YEAR_SELECTED = Object.keys(dataGlobal)[0];
                    cargarModalAnios();
                    cargarSemestresSidebar();
                });

            function cargarModalAnios() {
                const lista = document.getElementById("lista-anios");
                lista.innerHTML = "";
                Object.keys(dataGlobal).forEach(anio => {
                    let a = document.createElement('a');
                    a.className = "collection-item";
                    a.innerText = anio;
                    a.onclick = () => {
                        YEAR_SELECTED = anio;
                        cargarSemestresSidebar();
                        M.Modal.getInstance(document.getElementById("modal-anios")).close();
                    };
                    lista.appendChild(a);
                });
            }

            function cargarSemestresSidebar() {
                const coll = document.getElementById("semestres-collapsible");
                coll.innerHTML = "";
                const semestres = Object.keys(dataGlobal[YEAR_SELECTED]);

                semestres.forEach(sem => {
                    const li = document.createElement("li");
                    const nombre = sem.replace("_", " ").toUpperCase();
                    li.innerHTML = `
                        <div class="collapsible-header"><i class="material-icons">keyboard_arrow_down</i>${nombre}</div>
                        <div class="collapsible-body" style="padding:0;">
                            <div class="collection" id="sec-${sem}" style="border:0; margin:0;"></div>
                        </div>
                    `;
                    coll.appendChild(li);

                    const secList = li.querySelector(`#sec-${sem}`);
                    const semData = dataGlobal[YEAR_SELECTED][sem];

                    Object.keys(semData.secretarias).forEach(cod => {
                        const sec = semData.secretarias[cod];
                        const item = document.createElement("a");
                        item.className = "collection-item";
                        item.innerText = sec.nombre;
                        item.onclick = (e) => {
                            e.preventDefault();
                            cargarDirecciones(sec);
                            if(window.innerWidth <= 992) M.Sidenav.getInstance(document.getElementById('slide-out')).close();
                        };
                        secList.appendChild(item);
                    });
                });
                M.Collapsible.init(coll);
            }

            function cargarDirecciones(sec) {
                const tabs = document.getElementById("direcciones-tabs");
                const select = document.getElementById("direcciones-select");
                tabs.innerHTML = "";
                select.innerHTML = "";

                if (!sec.direcciones || sec.direcciones.length === 0) return;

                sec.direcciones.forEach((dir, idx) => {
                    let li = document.createElement("li");
                    li.className = "tab";
                    li.innerHTML = `<a href="#dir${idx}">${dir.nombre}</a>`;
                    li.onclick = () => cargarDireccion(dir);
                    tabs.appendChild(li);

                    let opt = document.createElement("option");
                    opt.value = idx;
                    opt.innerText = dir.nombre;
                    select.appendChild(opt);
                });

                select.onchange = (e) => cargarDireccion(sec.direcciones[e.target.value]);
                M.Tabs.init(tabs);
                cargarDireccion(sec.direcciones[0]);
            }

            function cargarDireccion(dir) {
                const funcBox = document.getElementById("func-list");
                funcBox.innerHTML = `<h6><b>${dir.nombre}</b></h6><p>Empleados: ${dir.empleados}</p>`;
                if (dir.funcionarios) {
                    Object.entries(dir.funcionarios).forEach(([cargo, nombre]) => {
                        funcBox.innerHTML += `<p>${cargo}: <b>${nombre}</b></p>`;
                    });
                }

                const presup = (dir.gastos || []).reduce((a, g) => a + (g.presupuestado || 0) + (g.reestructura || 0), 0);
                const comprom = (dir.gastos || []).reduce((a, g) => a + (g.comprometido || 0), 0);

                const ctx = document.getElementById("chart-actual").getContext("2d");
                if (chartInstance) chartInstance.destroy();
                chartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Presupuestado', 'Ejecutado'],
                        datasets: [{
                            label: '$ ARS',
                            data: [presup, comprom],
                            backgroundColor: ['#64b5f6', '#4caf50']
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });

                const montos = new Array(7).fill(0);
                (dir.gastos || []).forEach(g => {
                    const idx = Z_MAPPING[`Z=${g.codigoZ}`];
                    if (idx !== undefined) montos[idx] += (g.comprometido || 0);
                });

                const bars = document.querySelectorAll('#progress-container .progress');
                const titles = document.querySelectorAll('#progress-container .progress-title');
                bars.forEach((bar, i) => {
                    const pct = presup ? Math.round((montos[i] / presup) * 100) : 0;
                    bar.querySelector(".determinate").style.width = Math.min(pct, 100) + "%";
                    titles[i].innerText = `${PROGRESS_TITLES[i]} — $ ${montos[i].toLocaleString("es-AR")}`;
                });
            }
        });
    </script>
</body>
</html>